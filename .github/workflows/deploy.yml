name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install Python dependencies
        working-directory: backend
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov

      - name: Run Python tests
        working-directory: backend
        run: |
          pytest tests/ -v --tb=short || echo "No tests yet"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-directory-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Build frontend
        working-directory: frontend
        run: npm run build

  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Create .env file on server
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENVSSH'
          cat > /opt/solana-trading-bot/.env << 'ENVFILE'
          # Database
          DATABASE_URL=postgresql+asyncpg://trading:trading@postgres:5432/trading

          # Solana
          SOLANA_RPC_URL=${{ secrets.SOLANA_RPC_URL }}
          DRIFT_ENV=${{ secrets.DRIFT_ENV }}
          WALLET_PRIVATE_KEY=${{ secrets.WALLET_PRIVATE_KEY }}

          # Azure OpenAI (GitHub Enterprise)
          USE_AZURE_OPENAI=true
          AZURE_OPENAI_API_KEY=${{ secrets.AZURE_OPENAI_API_KEY }}
          AZURE_OPENAI_ENDPOINT=${{ secrets.AZURE_OPENAI_ENDPOINT }}
          AZURE_OPENAI_DEPLOYMENT=${{ secrets.AZURE_OPENAI_DEPLOYMENT }}
          AZURE_OPENAI_API_VERSION=${{ secrets.AZURE_OPENAI_API_VERSION }}
          LLM_MODEL=${{ secrets.LLM_MODEL }}

          # App Settings
          CHECK_INTERVAL_SECONDS=${{ secrets.CHECK_INTERVAL_SECONDS }}
          LOG_LEVEL=${{ secrets.LOG_LEVEL }}
          SECRET_KEY=${{ secrets.APP_SECRET_KEY }}
          ENVFILE
          ENVSSH

      - name: Deploy to EC2
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'DEPLOYSSH'
          set -e
          
          cd /opt/solana-trading-bot
          
          # Pull latest code
          if [ -d ".git" ]; then
            git fetch origin main
            git reset --hard origin/main
          else
            git clone https://github.com/${{ github.repository }}.git .
          fi
          
          # Build and deploy
          docker-compose down --remove-orphans || true
          docker-compose build --no-cache
          docker-compose up -d
          
          # Wait for services
          sleep 15
          
          # Run migrations
          docker-compose exec -T api alembic upgrade head || echo "Migrations skipped"
          
          # Cleanup
          docker image prune -f
          
          # Health check
          curl -sf http://localhost:8000/health || echo "Health check warning"
          
          echo "Deployment completed successfully!"
          docker-compose ps
          DEPLOYSSH

      - name: Verify deployment
        run: |
          sleep 10
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'CHECKSSH'
          echo "=== Container Status ==="
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          
          echo ""
          echo "=== Health Check ==="
          curl -sf http://localhost:8000/health && echo "API is healthy!" || echo "API health check failed"
          CHECKSSH

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key
